<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸ì¹´ë§ˆíŠ¸ í¬ìŠ¤ê¸°</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
        h1 { text-align: center; }
        .item-list { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
        .item-row { display: flex; align-items: center; margin-bottom: 10px; }
        .item-row input { margin-left: 10px; width: 60px; }
        .total-section { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        #total-krw, #total-idr { font-size: 1.2em; font-weight: bold; margin-top: 5px; }
        #donation, #total-revenue { font-size: 1.5em; font-weight: bold; margin-top: 10px; }
        button { padding: 10px 20px; }
        .sales-record-item { border: 1px solid #ddd; margin-bottom: 10px; }
        .sales-record-summary { display: flex; justify-content: space-between; align-items: center; padding: 10px; cursor: pointer; background-color: #f9f9f9; }
        .sales-record-details { padding: 10px; border-top: 1px solid #ddd; display: none; }
        .delete-button { background-color: #f44336; color: white; border: none; padding: 5px 10px; cursor: pointer; }
        .pagination { text-align: center; margin-top: 20px; }
        .pagination button { margin: 0 5px; cursor: pointer; padding: 5px 10px; }
        .pagination button.active { background-color: #007bff; color: white; border: 1px solid #007bff; }
        #currency-selector { margin-bottom: 15px; padding: 8px; }
    </style>
</head>
<body>
    <h1>ì¸ì¹´ë§ˆíŠ¸ í¬ìŠ¤ê¸°</h1>
    <p><a href="stock.html">ì¬ê³  ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™</a></p>
    
    <h2>íŒë§¤ ëª©ë¡</h2>
    <div class="item-list" id="item-list">
        </div>

    <hr>
    <div>
        <label for="currency-selector">ê²°ì œ í†µí™”:</label>
        <select id="currency-selector">
            <option value="krw">â‚© ì›í™” (KRW)</option>
            <option value="idr">Rp ë£¨í”¼ì•„ (IDR)</option>
        </select>
    </div>

    <div class="total-section">
        <p>ì´ í•©ê³„:</p>
        <p><span id="total-krw">0 ì›</span></p>
    </div>
    
    <div>
        <label for="received-amount">ë°›ì€ ê¸ˆì•¡:</label>
        <input type="number" id="received-amount" min="0">
        <span id="received-currency">ì›</span>
    </div>
    
    <p>ê¸°ë¶€ê¸ˆ: <span id="donation">0</span> <span id="donation-currency">ì›</span></p>
    
    <button id="save-button">ì €ì¥</button>

    <hr>
    <h2>íŒë§¤ ê¸°ë¡</h2>
    <div id="sales-history">
        </div>
    <div id="pagination-container" class="pagination">
        </div>
    <p>ì´ ë§¤ì¶œì•¡: <span id="total-revenue">0</span> ì›</p>


    <script>
        // ğŸ’¡ ì—¬ê¸°ì— êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ë°°í¬ ì‹œ ë³µì‚¬í•œ ì›¹ ì•± URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyMLM-EZCrArJ31m84oyMnSlO0FM3QYisJWtJNfTLAZzkFGcf4uZKZw2oDiJnjBTUQD/exec';

        let currentPage = 1;
        const recordsPerPage = 10;
        let previousDate = null;
        let allSalesRecords = [];
        let allItems = [];
        let itemPrices = {};

        async function fetchPrices() {
            const response = await fetch(`${WEB_APP_URL}?sheet=prices`);
            const prices = await response.json();
            return prices;
        }

        async function fetchStock() {
            const response = await fetch(`${WEB_APP_URL}?sheet=stock`);
            const stock = await response.json();
            return stock;
        }

        async function saveStock(stockLevels) {
            await fetch(`${WEB_APP_URL}?sheet=stock`, {
                method: 'POST',
                body: JSON.stringify({ stockLevels: stockLevels }),
                headers: { 'Content-Type': 'application/json' }
            });
        }
        
        async function fetchSalesHistory() {
            const response = await fetch(`${WEB_APP_URL}?sheet=sales`);
            const sales = await response.json();
            allSalesRecords = sales;
            return sales;
        }

        async function saveSaleRecord(newRecord) {
            await fetch(`${WEB_APP_URL}?sheet=sales`, {
                method: 'POST',
                body: JSON.stringify(newRecord),
                headers: { 'Content-Type': 'application/json' }
            });
        }
        
        async function loadPricesAndRender() {
            allItems = await fetchPrices();
            const itemListDiv = document.getElementById('item-list');
            itemListDiv.innerHTML = '';
            
            allItems.forEach(item => {
                itemPrices[item.item_id] = { krw: item.price_krw, idr: item.price_idr, name: item.name };
                const itemRow = document.createElement('div');
                itemRow.className = 'item-row';
                itemRow.innerHTML = `
                    <span>${item.name}: </span>
                    <input type="number" data-id="${item.item_id}" class="item-quantity" value="" min="0"> ê°œ
                    <span class="stock-info" id="${item.item_id}-stock"></span>
                `;
                itemListDiv.appendChild(itemRow);
            });
            
            document.querySelectorAll('.item-quantity').forEach(input => {
                input.addEventListener('input', calculateTotal);
            });
        }

        async function loadStockAndRender() {
            const stock = await fetchStock();
            allItems.forEach(item => {
                const stockSpan = document.getElementById(`${item.item_id}-stock`);
                if (stockSpan) {
                    stockSpan.innerText = `(ì¬ê³ : ${stock[item.item_id] || 0})`;
                }
            });
        }

        function calculateTotal() {
            const currency = document.getElementById('currency-selector').value;
            let total = 0;
            document.querySelectorAll('.item-quantity').forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const itemId = input.dataset.id;
                const priceKey = `price_${currency}`;
                total += itemPrices[itemId][priceKey] * quantity;
            });
            
            const totalSpan = document.getElementById('total-krw');
            totalSpan.innerText = `${total.toLocaleString()} ${currency === 'krw' ? 'ì›' : 'ë£¨í”¼ì•„'}`;
            calculateDonation();
        }

        function calculateDonation() {
            const total = parseFloat(document.getElementById('total-krw').innerText.replace(/[^\d]/g, ''));
            const received = parseInt(document.getElementById('received-amount').value) || 0;
            const donation = received - total;
            
            const donationSpan = document.getElementById('donation');
            const donationCurrencySpan = document.getElementById('donation-currency');
            donationSpan.innerText = Math.max(0, donation).toLocaleString();
            donationCurrencySpan.innerText = document.getElementById('received-currency').innerText;
        }
        
        function updateCurrencyDisplay() {
            const currency = document.getElementById('currency-selector').value;
            const currencyText = currency === 'krw' ? 'ì›' : 'ë£¨í”¼ì•„';
            document.getElementById('received-currency').innerText = currencyText;
            document.getElementById('donation-currency').innerText = currencyText;
            calculateTotal();
        }

        function calculateTotalRevenue() {
            let totalRevenue = 0;
            allSalesRecords.forEach(record => {
                if (record['íŒë§¤í†µí™”'] === 'krw') {
                    totalRevenue += parseInt(record['ì´ê¸ˆì•¡']);
                }
            });
            document.getElementById('total-revenue').innerText = totalRevenue.toLocaleString();
        }

        async function saveSale() {
            const now = new Date();
            const date = `${now.getFullYear().toString().slice(-2)}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
            const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            let noItemsSelected = true;
            const saleItemsData = {};
            const currentStock = await fetchStock();

            document.querySelectorAll('.item-quantity').forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const itemId = input.dataset.id;
                if (quantity > 0) {
                    currentStock[itemId] -= quantity;
                    saleItemsData[itemId] = quantity;
                    noItemsSelected = false;
                }
            });

            if (noItemsSelected) {
                alert('íŒë§¤í•  ë¬¼í’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            await saveStock(currentStock);
            await loadStockAndRender();
            
            const totalString = document.getElementById('total-krw').innerText.replace(/[^\d]/g, '');
            const total = parseFloat(totalString);
            
            let received = parseInt(document.getElementById('received-amount').value) || total;
            const donation = received - total;
            const currency = document.getElementById('currency-selector').value;
            
            const newRecord = {
                date: date,
                time: time,
                currency: currency,
                total: total,
                received: received,
                donation: donation,
                items: saleItemsData
            };
            
            await saveSaleRecord(newRecord);
            await renderSalesHistory();
            calculateTotalRevenue();

            document.querySelectorAll('.item-quantity').forEach(input => input.value = '');
            document.getElementById('received-amount').value = '';
            calculateTotal();
            alert('íŒë§¤ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
        
        async function deleteSale(event) {
            alert('í˜„ì¬ ì‚­ì œ ê¸°ëŠ¥ì€ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ì§ì ‘ ì‚­ì œí•´ì£¼ì„¸ìš”.');
            return;
        }

        async function renderSalesHistory() {
            const salesHistoryDiv = document.getElementById('sales-history');
            const paginationDiv = document.getElementById('pagination-container');
            salesHistoryDiv.innerHTML = '';
            paginationDiv.innerHTML = '';
            
            await fetchSalesHistory();
            previousDate = null;

            const totalPages = Math.ceil(allSalesRecords.length / recordsPerPage);
            const start = (currentPage - 1) * recordsPerPage;
            const end = start + recordsPerPage;
            const recordsToDisplay = allSalesRecords.slice(start, end);

            recordsToDisplay.forEach((record, index) => {
                let saleDetailsHtml = '<ul>';
                for (const itemId in record['íŒë§¤ëª©ë¡']) {
                    const item = itemPrices[itemId];
                    if (item) {
                       const priceKey = `price_${record['íŒë§¤í†µí™”']}`;
                       saleDetailsHtml += `<li>${item.name}: ${record['íŒë§¤ëª©ë¡'][itemId]}ê°œ (${itemPrices[itemId][priceKey] * record['íŒë§¤ëª©ë¡'][itemId]} ${record['íŒë§¤í†µí™”'] === 'krw' ? 'ì›' : 'ë£¨í”¼ì•„'})</li>`;
                    }
                }
                saleDetailsHtml += '</ul>';

                let displayDate = '';
                if (record['ë‚ ì§œ'] !== previousDate) {
                    displayDate = record['ë‚ ì§œ'];
                    previousDate = record['ë‚ ì§œ'];
                }

                const totalCurrency = record['íŒë§¤í†µí™”'] === 'krw' ? 'ì›' : 'ë£¨í”¼ì•„';
                const saleRecordHtml = `
                    <div class="sales-record-item">
                        <div class="sales-record-summary">
                            <span>${displayDate}&nbsp;&nbsp;${record['ì‹œê°„']} - ì´ ê¸ˆì•¡: ${record['ì´ê¸ˆì•¡'].toLocaleString()} ${totalCurrency}</span>
                            <div>
                                <button class="delete-button" data-index="${start + index}">ì‚­ì œ</button>
                                <span>â–¼</span>
                            </div>
                        </div>
                        <div class="sales-record-details">
                            <p><strong>ë°›ì€ ê¸ˆì•¡:</strong> ${record['ë°›ì€ê¸ˆì•¡'].toLocaleString()} ${totalCurrency}</p>
                            <p><strong>ê¸°ë¶€ê¸ˆ:</strong> ${record['ê¸°ë¶€ê¸ˆ'].toLocaleString()} ${totalCurrency}</p>
                            <p><strong>íŒë§¤ ëª©ë¡:</strong></p>
                            ${saleDetailsHtml}
                        </div>
                    </div>
                `;
                salesHistoryDiv.innerHTML += saleRecordHtml;
            });
            
            document.querySelectorAll('.sales-record-item').forEach(record => {
                const summary = record.querySelector('.sales-record-summary');
                const details = record.querySelector('.sales-record-details');
                const deleteButton = record.querySelector('.delete-button');

                summary.addEventListener('click', () => {
                    details.style.display = (details.style.display === 'none' || details.style.display === '') ? 'block' : 'none';
                });
                deleteButton.addEventListener('click', deleteSale);
            });

            if (totalPages > 1) {
                for (let i = 1; i <= totalPages; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.innerText = i;
                    if (i === currentPage) {
                        pageButton.classList.add('active');
                    }
                    pageButton.addEventListener('click', () => {
                        currentPage = i;
                        renderSalesHistory();
                    });
                    paginationDiv.appendChild(pageButton);
                }
            }
        }
        
        document.getElementById('received-amount').addEventListener('keydown', function(event) {
            if (event.key === 'Enter' || event.keyCode === 13) {
                saveSale();
            }
        });

        document.getElementById('received-amount').addEventListener('input', calculateDonation);
        document.getElementById('save-button').addEventListener('click', saveSale);
        document.getElementById('currency-selector').addEventListener('change', updateCurrencyDisplay);


        window.addEventListener('DOMContentLoaded', async () => {
            await loadPricesAndRender();
            await renderSalesHistory();
            await loadStockAndRender();
            calculateTotalRevenue();
            updateCurrencyDisplay();
        });
    </script>
</body>
</html>
